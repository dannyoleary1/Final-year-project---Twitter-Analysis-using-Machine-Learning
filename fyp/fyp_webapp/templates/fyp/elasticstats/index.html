<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    {% extends "base.html" %}
</head>
<body>

{% block content %}
            <div class="col-11">
                <div data-preset="stripe" style="width:50%;height:50%;margin:auto" class="ldBar label-center" data-value="50"></div>
            </div>

            <div class="container is-fluid" id="latest-update">

                <p id="update-status"></p>
            </div>
    <script>
               var poll_xhr;
   var willstop = 0;
  (function(){
    var poll = function(){
      var json_dump = "{{ data }}";
      var task_id = "{{task_id}}";
      var list = []
      poll_xhr = $.ajax({
        url:'process_elastic',
        type: 'POST',
        data: {
            task_id: task_id,
            csrfmiddlewaretoken: "{{csrf_token}}",
        },
        success: function(result) {
                        if (result.state == "SUCCESS") {
                            $("#latest-update").empty();
                            var updatedField = document.getElementById("latest-update")
                            var i = 0
                            var rowDiv = document.createElement("div")
                            var test = ""
                            keys = [];
                            var k;
                            var i;
                            var len;
                            for (k in result) {
                                if (result.hasOwnProperty(k)) {
                                    keys.push(k);
                                }
                            }

                            keys.sort();

                            len = keys.length;
                            var control = 0
                            for (i = 0; i < len; i++) {
                                entry = keys[i];
                                if (entry != "state"){
                                     if (control%2 == 0){
                                    test+="<div class='columns'>"
                                    }
                                test += "<div class='column'>"
                                test +="<div class='card-header'>"+entry+"</div>"
                                test +="<div class='card-body'> Total:  "+result[entry].total+"</div>"
                                    for (a=0; a<(result[entry].last_entries.hits.hits).length; a++){
                                         if (entry.includes("-latest")){
                                             test+= addToEntry(result[entry].last_entries.hits.hits[a]._source)
                                         }
                                         else if(result[entry].last_entries.hits.hits[a]._source.last_time == "No Tweets"){
                                             test += "<div>No Tweets in this index.</div>"
                                         }
                                         else{
                                             console.log(result[entry].last_entries.hits.hits[a]._source)
                                             console.log(entry)
                                             test += "<h2>Date of entry: "+ result[entry].last_entries.hits.hits[a]._source.date+"</h2>"
                                             test += "<h3>Total Tweets: " + result[entry].last_entries.hits.hits[a]._source.total+"</h3>"

                                             if (result[entry].last_entries.hits.hits[a]._source.last_time == undefined){
                                                 test += "work out later";
                                             }
                                             else if (result[entry].last_entries.hits.hits[a]._source.last_time.includes("00:00:00")){
                                                 test += "<h3>Last Collected: 00:00:00</h3>"
                                             }
                                             else{
                                                 test += "<h3 class=text-warning>Last Collected: "+result[entry].last_entries.hits.hits[a]._source.last_time+"</h3>"
                                             }
                                             if (result[entry].last_entries.hits.hits[a]._source.words == undefined){

                                             }
                                             else {
                                                 for (var b = 0; b<6; b++){
                                                     console.log("----------")
                                                     console.log(JSON.parse(result[entry].last_entries.hits.hits[a]._source.words))
                                                     test += "<span class=badge badge-dark>"+JSON.parse(result[entry].last_entries.hits.hits[a]._source.words)[b][0]+"</span>"
                                                 }
                                             }
                                         }
                                    }
                                test+="</div>"
                                if(control%2 != 0 && control !=0){
                                    test += "</div>"
                                }
                                control++
                                }
                            }
                            $('#latest-update').append(test);
                            willstop = 1;
                        }
                        else{
                            $("#update-status").empty();
                            var paragraph = document.getElementById("update-status");
                            var str1 = "Finished processing:    "
                            var str2 = result.entry
                            var text = document.createTextNode(str1.concat(str2));
                            paragraph.appendChild(text)
                        }
                    }
      });
    };
    var refreshIntervalId = setInterval(function() {
      poll();
      if(willstop == 1){
        clearInterval(refreshIntervalId);
      }
    },500);
  })();
  function addToEntry(data){
      var name = data.name
      var time = data.created
      var minutes = 0
      var displayTime = 0
      if (data.last_time == "No Tweets"){
          time = 0
          displayTime = "0m"
      }
      else {
          var diff = Math.abs(Date.now() - new Date(time.replace(/-/g,'/')));
          var minutes = (diff / (1000 * 60)).toFixed(0);
          var hours = (diff / (1000 * 60 * 60)).toFixed(0);
          var days = (diff / (1000 * 60 * 60 * 24)).toFixed(0);
          if (days < 1){
              if (hours < 1){
                  if (minutes > 0){
                      displayTime = minutes+"m"
                  }
              }
              else{
                   displayTime = hours+"h"
              }
          }
          else{
              displayTime = days+"d"
          }
      }
      var text = data.text
      var profile = data.profile_picture
      if (profile == undefined){
          profile = "https://bulma.io/images/placeholders/128x128.png"
      }
      var entry = "<div class=''>\n" +
          "<article class=\"media\">\n" +
          "  <figure class=\"media-left\">\n" +
          "    <p class=\"image is-64x64\">\n" +
          "      <img src="+profile+">\n" +
          "    </p>\n" +
          "  </figure>\n" +
          "  <div class=\"media-content is-clipped\">\n" +
          "    <div class=\"content\">\n" +
          "      <p>\n" +
          "        <strong>"+name+"</strong> <small>@"+name+"</small> <small>"+displayTime+"</small>\n" +
          "        <br>\n" +
          "        "+text+"\n" +
          "      </p>\n" +
          "    </div>\n" +
          "    <nav class=\"level is-mobile\">\n" +
          "      <div class=\"level-left\">\n" +
          "        <a class=\"level-item\">\n" +
          "          <span class=\"icon is-small\"><i class=\"fas fa-reply\"></i></span>\n" +
          "        </a>\n" +
          "        <a class=\"level-item\">\n" +
          "          <span class=\"icon is-small\"><i class=\"fas fa-retweet\"></i></span>\n" +
          "        </a>\n" +
          "        <a class=\"level-item\">\n" +
          "          <span class=\"icon is-small\"><i class=\"fas fa-heart\"></i></span>\n" +
          "        </a>\n" +
          "      </div>\n" +
          "    </nav>\n" +
          "  </div>\n" +
          " </article>\n" +
          "</div>\n" +
      "<br>";
      return entry
  }
    </script>
{% endblock content %}
</body>
</html>